version: v1.0
name: Initial Pipeline
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
blocks:
  - name: 'Block #1'
    task:
      jobs:
        - name: 'Job #1'
          commands:
            - checkout
  - name: new
    task:
      jobs:
        - name: 'Job #1'
          commands:
            - '- name: Install dependencies'
            - '  task:'
            - '    jobs:'
            - '      - name: bundle install'
            - '        commands:'
            - '          - checkout'
            - '          - cache restore gems-$SEMAPHORE_GIT_BRANCH-$(checksum Gemfile.lock),gems-$SEMAPHORE_GIT_BRANCH,gems-master'
            - '          - bundle install --deployment --path .bundle'
            - '          - cache store gems-$SEMAPHORE_GIT_BRANCH-$(checksum Gemfile.lock) .bundle'
  - name: 'bulder '
    task:
      jobs:
        - name: 'Job #1'
          commands:
            - 'blocks:'
            - '  - name: Install dependencies'
            - '    task:'
            - '      jobs:'
            - '        - name: bundle install'
            - '          commands:'
            - '            - checkout'
            - '            - cache restore gems-$SEMAPHORE_GIT_BRANCH-$(checksum Gemfile.lock),gems-$SEMAPHORE_GIT_BRANCH,gems-master'
            - '            - bundle install --deployment --path .bundle'
            - '            - cache store gems-$SEMAPHORE_GIT_BRANCH-$(checksum Gemfile.lock) .bundle'
  - name: 'Block #4'
    task:
      jobs:
        - name: 'Job #1'
          commands:
            - '- name: Tests'
            - '  task:'
            - '    jobs:'
            - '      - name: rspec'
            - '        commands:'
            - '          - checkout'
            - '          - cache restore gems-$SEMAPHORE_GIT_BRANCH-$(checksum Gemfile.lock),gems-$SEMAPHORE_GIT_BRANCH,gems-master'
            - '          - bundle install --deployment --path .bundle'
            - '          - bundle exec rspec'
promotions:
  - name: Promotion 1
    pipeline_file: pipeline_2.yml
    auto_promote:
      when: branch = 'master' AND result = 'passed'
